<!DOCTYPE html>
<html lang="bn">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Team Registration</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@latest/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Audiowide&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

  <style>
    body {
      background: radial-gradient(circle at top left, #120024, #220044, #0a0014);
      color: #f5f3ff;
      font-family: 'Poppins', sans-serif;
      min-height: 100vh;
    }

    .header-glow {
      box-shadow: 0 0 15px rgba(150, 0, 255, 0.4), 0 0 25px rgba(128, 0, 255, 0.2);
    }

    .form-container {
      background: rgba(25, 0, 50, 0.85);
      backdrop-filter: blur(8px);
      box-shadow: 0 0 20px rgba(100, 0, 255, 0.3);
    }

    input,
    select {
      background-color: rgba(10, 0, 20, 0.8);
      border: 1px solid #4b0082;
    }

    input:focus,
    select:focus {
      border-color: #8b5cf6;
      box-shadow: 0 0 10px rgba(139, 92, 246, 0.4);
    }

    .btn {
      font-weight: 600;
      background: linear-gradient(to right, #4c1d95, #7e22ce, #4c1d95);
      color: #f5f3ff;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 0 10px rgba(150, 0, 255, 0.4);
      transition: all 0.3s ease;
    }

    .btn:hover {
      box-shadow: 0 0 20px rgba(180, 0, 255, 0.7);
      transform: scale(1.05);
      background: linear-gradient(to right, #5b21b6, #9333ea, #5b21b6);
    }

    .nav-bottom {
      box-shadow: 0 -2px 20px rgba(120, 0, 255, 0.3);
    }

    .nav-box {
      background: rgba(126, 34, 206, 0.25);
    }

    .nav-item {
      color: #d0d1d1;
      transition: all 0.3s ease;
    }

    .nav-item i {
      color: #c084fc;
      transition: all 0.3s ease;
    }

    .nav-item:hover i {
      color: #facc15;
    }

    ::placeholder {
      color: #b0a7c3;
    }

    .payment-box {
      background: rgba(50, 0, 80, 0.7);
      border: 1px solid #8b5cf6;
      border-radius: 0.5rem;
      padding: 0.2rem 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .copy-icon {
      color: #facc15;
      transition: all 0.3s ease;
    }

    .copy-icon:hover {
      transform: scale(1.2);
    }

    /* ===== Loading Screen ===== */
    #loader {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at top left, #120024, #220044, #0a0014);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
      transition: opacity 0.6s ease, visibility 0.6s ease;
    }

    #loader.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loading-image {
      width: 90px;
      height: 90px;
      border-radius: 50%;
      border: 3px solid #facc15;
      padding: 5px;
      box-shadow: 0 0 10px #c084fc, 0 0 25px #facc15;
      animation: pulse 1.5s infinite alternate;
      margin-bottom: 15px;
    }

    @keyframes pulse {
      from {
        transform: scale(1);
        box-shadow: 0 0 10px #c084fc, 0 0 20px #facc15;
      }

      to {
        transform: scale(1.1);
        box-shadow: 0 0 25px #facc15, 0 0 40px #c084fc;
      }
    }

    .loading-text {
      font-family: 'Audiowide', cursive;
      background: linear-gradient(to right, #facc15, #c084fc, #f472b6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 1.2rem;
      letter-spacing: 2px;
      animation: glow 1.5s ease-in-out infinite alternate;
    }

    @keyframes glow {
      from {
        text-shadow: 0 0 5px #facc15, 0 0 10px #c084fc;
      }

      to {
        text-shadow: 0 0 10px #f472b6, 0 0 15px #c084fc;
      }
    }
  </style>
</head>

<body>

  <!-- Loading Screen -->
  <div id="loader">
    <img src="dls25.jpg" alt="Loading" class="loading-image" />
    <div class="loading-text">Loading...</div>
  </div>

  <!-- Header -->
  <header
    class="bg-gradient-to-r from-[#0a001f] via-[#2d0055] to-[#0a001f] w-full max-w-md shadow-md py-2 px-3 mx-auto border-b border-purple-500 flex items-center justify-between header-glow rounded-b-2xl">
    <div class="flex items-center space-x-2">
      <img src="dls25.jpg" alt="Logo" class="w-8 h-8 rounded-full border border-purple-500 shadow-md" />
      <h2 class="text-xl font-bold bg-gradient-to-r from-yellow-300 via-pink-300 to-yellow-300 bg-clip-text text-transparent"
        style="font-family: 'Audiowide', cursive;">DSL TOUR</h2>
    </div>
    <div>
      <button id="menuButton">
        <i class="fa-solid fa-bars text-white text-xl"></i>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-md mx-auto px-6 py-4">
    <h2 class="text-2xl font-bold text-center mb-3 bg-gradient-to-r from-yellow-400 to-pink-400 bg-clip-text text-transparent"
      style="font-family: 'Audiowide', cursive;">‡¶¶‡¶≤ ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶®</h2>

    <form id="teamForm"
      class="form-container py-2 px-3 rounded-xl shadow-xl border border-purple-500 space-y-4 max-w-sm mx-auto">

      <!-- Team Name -->
      <div>
        <label for="teamName" class="block text-sm font-semibold mb-2 text-gray-200">‡¶¶‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
        <input type="text" id="teamName" name="teamName" required
          class="w-full px-3 py-2 rounded-lg text-white focus:outline-none placeholder-gray-400 text-sm"
          placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
      </div>

      <!-- ID Rating -->
      <div>
        <label for="idRating" class="block text-sm font-semibold mb-2 text-gray-200">‡¶Ü‡¶á‡¶°‡¶ø ‡¶∞‡ßá‡¶ü‡¶ø‡¶Ç</label>
        <input type="number" id="idRating" step="any" name="idRating" required
          class="w-full px-3 py-2 rounded-lg text-white focus:outline-none placeholder-gray-400 text-sm"
          placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø ‡¶∞‡ßá‡¶ü‡¶ø‡¶Ç ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
      </div>

      <!-- Payment Method -->
      <div>
        <label for="paymentMethod" class="block text-sm font-semibold text-gray-200">‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ</label>
        <select id="paymentMethod" name="paymentMethod" required
          class="w-full px-3 py-2 rounded-lg text-white focus:outline-none text-sm">
          <option value="">‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>
          <option value="Bkash">‡¶¨‡¶ø‡¶ï‡¶æ‡¶∂</option>
          <option value="Nagad">‡¶®‡¶ó‡¶¶</option>
        </select>
      </div>

      <!-- Payment Notice -->
      <div class="text-center w-full">
        <p class="text-xs bg-gradient-to-r from-yellow-200 via-yellow-200 to-yellow-200 bg-clip-text text-transparent font-semibold mb-1">
          üì£ ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶≤‡ßá ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶Ü‡¶™‡¶®‡¶æ‡¶ï‡ßá ‡¶®‡¶ø‡¶ö‡ßá ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞‡ßá <span id="entryFee"></span> ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶∏‡ßá‡¶®‡ßç‡¶°‡¶Æ‡¶æ‡¶®‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶®‡¶æ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ó‡ßç‡¶∞‡¶π‡¶£‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§
        </p>
        <div class="payment-box mx-auto w-fit" id="paymentBox">
          <span id="paymentNumber" class="font-semibold text-green-400">01856549856</span>
          <i class="fa-regular fa-copy copy-icon" title="Copy Number"></i>
        </div>
      </div>

      <!-- Transaction ID -->
      <div>
        <label for="trxId" class="block text-sm font-semibold mb-2 text-gray-200">‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶Ü‡¶á‡¶°‡¶ø (‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶®)</label>
        <input type="text" id="trxId" name="trxId" required
          class="w-full px-3 py-2 rounded-lg text-white focus:outline-none placeholder-gray-400 text-sm"
          placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶® ‡¶Ü‡¶á‡¶°‡¶ø ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
      </div>

      <!-- Submit Button -->
      <div class="flex justify-center">
        <button type="submit" class="btn w-full py-2 text-base rounded-lg transition-all duration-300">
          ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
      </div>
    </form>
  </main>

  <!-- Bottom Navigation -->
  <nav class="nav-bottom fixed bg-gradient-to-r from-[#0a001f] via-[#2d0055] to-[#0a001f] bottom-0 left-0 right-0 flex justify-around items-center py-2 rounded-t-2xl text-white h-16 sm:h-14 sm:px-2 z-50 border-t border-purple-500">
    <a href="index.html" class="nav-item flex flex-col items-center text-xs font-semibold no-underline">
      <div class="nav-box w-9 h-9 rounded-full mb-1 flex items-center justify-center border border-purple-500">
        <i class="fa-solid fa-house text-lg"></i>
      </div>
      Home
    </a>
    <a href="shop.html" class="nav-item flex flex-col items-center text-xs font-semibold no-underline">
      <div class="nav-box w-9 h-9 rounded-full mb-1 flex items-center justify-center border border-purple-500">
        <i class="fa-solid fa-cart-plus text-lg"></i>
      </div>
      DLS Shop
    </a>
    <a href="index.html" class="nav-item flex flex-col items-center text-xs font-semibold no-underline">
      <div class="nav-box w-9 h-9 rounded-full mb-1 flex items-center justify-center border border-purple-500">
        <i class="fa-solid fa-trophy text-lg"></i>
      </div>
      Tour Match
    </a>
    <a href="team-rank.html" class="nav-item flex flex-col items-center text-xs font-semibold no-underline">
      <div class="nav-box w-9 h-9 rounded-full mb-1 flex items-center justify-center border border-purple-500">
        <i class="fa-solid fa-ranking-star text-lg"></i>
      </div>
      Ranking
    </a>
    <a href="profile.html" class="nav-item flex flex-col items-center text-xs font-semibold no-underline">
      <div class="nav-box w-9 h-9 rounded-full mb-1 flex items-center justify-center border border-purple-500">
        <i class="fa-solid fa-user text-lg"></i>
      </div>
      Profile
    </a>
  </nav>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDooTNeDHoWUU9nLxYxyBIhewydt7Xl_M0",
      authDomain: "dlstournament-31ac1.firebaseapp.com",
      databaseURL: "https://dlstournament-31ac1-default-rtdb.firebaseio.com",
      projectId: "dlstournament-31ac1",
      storageBucket: "dlstournament-31ac1.appspot.com",
      messagingSenderId: "874377019055",
      appId: "1:874377019055:web:6e38db2ec7f0d541d2de5a",
      measurementId: "G-0DGFJEV6GL"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentSessionName = "";
    let entryFee = "";

    const loader = document.getElementById("loader");

    // ‚úÖ Real-time toursetting listener with loading
    const loadSettings = async () => {
      try {
        onSnapshot(collection(db, "toursetting"), (snapshot) => {
          snapshot.forEach((doc) => {
            const data = doc.data();
            if (data.session) currentSessionName = data.session;
            if (data.entryFee) entryFee = data.entryFee;
          });
          document.getElementById("entryFee").innerText = entryFee || "‚Äî";
          loader.classList.add("hidden");
        });
      } catch (error) {
        console.error("Error loading settings:", error);
        loader.classList.add("hidden");
      }
    };

    loadSettings();

    // ‚úÖ Team form submit event
    const teamForm = document.getElementById("teamForm");
    teamForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const user = auth.currentUser;
      if (!user) {
        Swal.fire({
          icon: 'error',
          title: '‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®',
          text: '‡¶¶‡¶≤ ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶®‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®!',
          confirmButtonColor: '#dc2626'
        });
        return;
      }

      const uid = user.uid;
      const teamName = document.getElementById("teamName").value.trim();
      const idRating = parseFloat(document.getElementById("idRating").value);
      const paymentMethod = document.getElementById("paymentMethod").value;
      const trxId = document.getElementById("trxId").value.trim();

      // üåÄ Processing Popup Show
      Swal.fire({
        title: 'Processing...',
        html: `
          <div class="flex flex-col items-center">
            <i class="fa-solid fa-spinner fa-spin text-purple-400 text-3xl mb-3"></i>
            <p>‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®, ‡¶ï‡¶ø‡¶õ‡ßÅ ‡¶∏‡¶Æ‡¶Ø‡¶º‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá<br>‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶π‡¶Ø‡¶º‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§</p>
          </div>
        `,
        allowOutsideClick: false,
        showConfirmButton: false,
        background: '#1e0a3c',
        color: '#f5f3ff'
      });

      try {
        // ‚úÖ Check existing user registration
        const qUser = query(collection(db, "playerlist"),
          where("uid", "==", uid),
          where("status", "in", ["Pending", "Approved"])
        );
        const existingUser = await getDocs(qUser);
        if (!existingUser.empty) {
          Swal.close();
          Swal.fire({
            icon: 'warning',
            title: 'Already Registration Successful',
            text: '‡¶Ü‡¶™‡¶®‡¶ø ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶è‡¶ï‡¶ü‡¶ø ‡¶¶‡¶≤ ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶® ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡¶®!',
            confirmButtonColor: '#f59e0b'
          });
          return;
        }

        // ‚úÖ Check existing team name
        const qTeam = query(collection(db, "playerlist"),
          where("teamName", "==", teamName),
          where("sessionName", "==", currentSessionName)
        );
        const existingTeam = await getDocs(qTeam);
        if (!existingTeam.empty) {
          Swal.close();
          Swal.fire({
            icon: 'warning',
            title: '‡¶¶‡¶≤ ‡¶®‡¶æ‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡ßÉ‡¶§ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá',
            text: '‡¶è‡¶á ‡¶¶‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá‡¶á ‡¶®‡¶ø‡¶¨‡¶®‡ßç‡¶ß‡¶ø‡¶§‡•§ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶®‡¶æ‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§',
            confirmButtonColor: '#f59e0b'
          });
          return;
        }

        // ‚úÖ Fetch user's photoUrl from 'users' collection
        const userDoc = await getDoc(doc(db, "users", uid));
        let photoUrl = "";
        if (userDoc.exists()) {
          const userData = userDoc.data();
          photoUrl = userData.photoUrl || "";
        }

        const formData = {
          uid,
          teamName,
          idRating,
          paymentMethod,
          trxId,
          entryFee: entryFee,
          sessionName: currentSessionName,
          status: "Pending",
          photoUrl, // üî• added photoUrl
          date: new Date()
        };

        await addDoc(collection(db, "playerlist"), formData);
        await addDoc(collection(db, "reghistory"), formData);

        Swal.close();
        Swal.fire({
          icon: 'success',
          title: '‡¶∏‡¶´‡¶≤',
          text: '‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¶‡¶≤ ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!',
          confirmButtonColor: '#6f1287',
          timer: 2000,
          showConfirmButton: false
        });

        teamForm.reset();

        setTimeout(() => {
          window.location.href = "reg-history.html";
        }, 2000);

      } catch (error) {
        Swal.close();
        console.error(error);
        Swal.fire({
          icon: 'error',
          title: '‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø',
          text: '‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶¶‡¶≤‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!',
          confirmButtonColor: '#dc2626'
        });
      }
    });

    // ‚úÖ Copy Payment Number
    const paymentBox = document.getElementById("paymentBox");
    paymentBox.addEventListener("click", async () => {
      const number = document.getElementById("paymentNumber").innerText;
      try {
        await navigator.clipboard.writeText(number);
        Swal.fire({
          icon: 'success',
          title: 'Copied!',
          text: 'Payment number copied to clipboard',
          timer: 1500,
          showConfirmButton: false,
          background: '#1e0a3c',
          color: '#f5f3ff'
        });
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    });
  </script>

</body>
</html>
